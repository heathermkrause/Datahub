/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
!function(e){var t={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(e){return"<li>"+e[this.propertyToSearch]+"</li>"},tokenFormatter:function(e){return"<li><p>"+e[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},n={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},r={BEFORE:0,AFTER:1,END:2},i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},o={init:function(n,r){var i=e.extend({},t,r||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,n,i))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this},get:function(){return this.data("tokenInputObject").getTokens()}};e.fn.tokenInput=function(e){return o[e]?o[e].apply(this,Array.prototype.slice.call(arguments,1)):o.init.apply(this,arguments)},e.TokenList=function(t,o,a){function s(){return null!==a.tokenLimit&&F>=a.tokenLimit?(_.hide(),g(),void 0):void 0}function l(){if(D!==(D=_.val())){var e=D.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");R.html(e),_.width(R.width()+30)}}function u(t){var n=a.tokenFormatter(t);n=e(n).addClass(a.classes.token).insertBefore($),e("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(n).click(function(){return h(e(this).parent()),O.change(),!1});var r={id:t.id};return r[a.propertyToSearch]=t[a.propertyToSearch],e.data(n.get(0),"tokeninput",t),L=L.slice(0,P).concat([r]).concat(L.slice(P)),P++,m(L,O),F+=1,null!==a.tokenLimit&&F>=a.tokenLimit&&(_.hide(),g()),n}function c(t){var n=a.onAdd;if(F>0&&a.preventDuplicates){var r=null;if(q.children().each(function(){var n=e(this),i=e.data(n.get(0),"tokeninput");return i&&i.id===t.id?(r=n,!1):void 0}),r)return f(r),$.insertAfter(r),_.focus(),void 0}(null==a.tokenLimit||F<a.tokenLimit)&&(u(t),s()),_.val(""),g(),e.isFunction(n)&&n.call(O,t)}function f(e){e.addClass(a.classes.selectedToken),H=e.get(0),_.val(""),g()}function d(e,t){e.removeClass(a.classes.selectedToken),H=null,t===r.BEFORE?($.insertBefore(e),P--):t===r.AFTER?($.insertAfter(e),P++):($.appendTo(q),P=F),_.focus()}function p(t){var n=H;H&&d(e(H),r.END),n===t.get(0)?d(t,r.END):f(t)}function h(t){var n=e.data(t.get(0),"tokeninput"),r=a.onDelete,i=t.prevAll().length;i>P&&i--,t.remove(),H=null,_.focus(),L=L.slice(0,i).concat(L.slice(i+1)),P>i&&P--,m(L,O),F-=1,null!==a.tokenLimit&&_.show().val("").focus(),e.isFunction(r)&&r.call(O,n)}function m(t,n){var r=e.map(t,function(e){return e[a.tokenValue]});n.val(r.join(a.tokenDelimiter))}function g(){B.hide().empty(),I=null}function v(){B.css({position:"absolute",top:e(q).offset().top+e(q).outerHeight(),left:e(q).offset().left,zindex:999}).show()}function y(){a.searchingText&&(B.html("<p>"+a.searchingText+"</p>"),v())}function b(){a.hintText&&(B.html("<p>"+a.hintText+"</p>"),v())}function x(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function w(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","g"),x(t,n))}function T(t,n){if(n&&n.length){B.empty();var r=e("<ul>").appendTo(B).mouseover(function(t){C(e(t.target).closest("li"))}).mousedown(function(t){return c(e(t.target).closest("li").data("tokeninput")),O.change(),!1}).hide();e.each(n,function(n,i){var o=a.resultsFormatter(i);o=w(o,i[a.propertyToSearch],t),o=e(o).appendTo(r),n%2?o.addClass(a.classes.dropdownItem):o.addClass(a.classes.dropdownItem2),0===n&&C(o),e.data(o.get(0),"tokeninput",i)}),v(),a.animateDropdown?r.slideDown("fast"):r.show()}else a.noResultsText&&(B.html("<p>"+a.noResultsText+"</p>"),v())}function C(t){t&&(I&&N(e(I)),t.addClass(a.classes.selectedDropdownItem),I=t.get(0))}function N(e){e.removeClass(a.classes.selectedDropdownItem),I=null}function k(){var t=_.val().toLowerCase();t&&t.length&&(H&&d(e(H),r.AFTER),t.length>=a.minChars?(y(),clearTimeout(j),j=setTimeout(function(){E(t)},a.searchDelay)):g())}function E(t){var n=t+S(),r=M.get(n);if(r)T(t,r);else if(a.url){var i=S(),o={};if(o.data={},i.indexOf("?")>-1){var s=i.split("?");o.url=s[0];var l=s[1].split("&");e.each(l,function(e,t){var n=t.split("=");o.data[n[0]]=n[1]})}else o.url=i;o.data[a.queryParam]=t,o.type=a.method,o.dataType=a.contentType,a.crossDomain&&(o.dataType="jsonp"),o.success=function(r){e.isFunction(a.onResult)&&(r=a.onResult.call(O,r)),M.add(n,a.jsonContainer?r[a.jsonContainer]:r),_.val().toLowerCase()===t&&T(t,a.jsonContainer?r[a.jsonContainer]:r)},e.ajax(o)}else if(a.local_data){var u=e.grep(a.local_data,function(e){return e[a.propertyToSearch].toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(a.onResult)&&(u=a.onResult.call(O,u)),M.add(n,u),T(t,u)}}function S(){var e=a.url;return"function"==typeof a.url&&(e=a.url.call()),e}if("string"===e.type(o)||"function"===e.type(o)){a.url=o;var A=S();void 0===a.crossDomain&&(a.crossDomain=-1===A.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==A.split(/\/+/g)[1])}else"object"==typeof o&&(a.local_data=o);a.classes?a.classes=e.extend({},n,a.classes):a.theme?(a.classes={},e.each(n,function(e,t){a.classes[e]=t+"-"+a.theme})):a.classes=n;var j,D,L=[],F=0,M=new e.TokenList.Cache,_=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+t.id).focus(function(){(null===a.tokenLimit||a.tokenLimit!==F)&&b()}).blur(function(){g(),e(this).val("")}).bind("keyup keydown blur update",l).keydown(function(t){var n,o;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(e(this).val()){var a=null;return a=t.keyCode===i.DOWN||t.keyCode===i.RIGHT?e(I).next():e(I).prev(),a.length&&C(a),!1}n=$.prev(),o=$.next(),n.length&&n.get(0)===H||o.length&&o.get(0)===H?t.keyCode===i.LEFT||t.keyCode===i.UP?d(e(H),r.BEFORE):d(e(H),r.AFTER):t.keyCode!==i.LEFT&&t.keyCode!==i.UP||!n.length?t.keyCode!==i.RIGHT&&t.keyCode!==i.DOWN||!o.length||f(e(o.get(0))):f(e(n.get(0)));break;case i.BACKSPACE:if(n=$.prev(),!e(this).val().length)return H?(h(e(H)),O.change()):n.length&&f(e(n.get(0))),!1;1===e(this).val().length?g():setTimeout(function(){k()},5);break;case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:case i.COMMA:if(I)return c(e(I).data("tokeninput")),O.change(),!1;break;case i.ESCAPE:return g(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){k()},5)}}),O=e(t).hide().val("").focus(function(){_.focus()}).blur(function(){_.blur()}),H=null,P=0,I=null,q=e("<ul />").addClass(a.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?p(n):(H&&d(e(H),r.END),_.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&H!==this&&n.addClass(a.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&H!==this&&n.removeClass(a.classes.highlightedToken)}).insertBefore(O),$=e("<li />").addClass(a.classes.inputToken).appendTo(q).append(_),B=e("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),R=e("<tester/>").insertAfter(_).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:_.css("fontSize"),fontFamily:_.css("fontFamily"),fontWeight:_.css("fontWeight"),letterSpacing:_.css("letterSpacing"),whiteSpace:"nowrap"});O.val("");var W=a.prePopulate||O.data("pre");a.processPrePopulate&&e.isFunction(a.onResult)&&(W=a.onResult.call(O,W)),W&&W.length&&e.each(W,function(e,t){u(t),s()}),e.isFunction(a.onReady)&&a.onReady.call(),this.clear=function(){q.children("li").each(function(){0===e(this).children("input").length&&h(e(this))})},this.add=function(e){c(e)},this.remove=function(t){q.children("li").each(function(){if(0===e(this).children("input").length){var n=e(this).data("tokeninput"),r=!0;for(var i in t)if(t[i]!==n[i]){r=!1;break}r&&h(e(this))}})},this.getTokens=function(){return L}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),r={},i=0,o=function(){r={},i=0};this.add=function(e,t){i>n.max_size&&o(),r[e]||(i+=1),r[e]=t},this.get=function(e){return r[e]}}}(jQuery);